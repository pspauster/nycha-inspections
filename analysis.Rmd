---
title: "Analysis"
author: "Patrick"
date: "2024-03-18"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(beeswarm)
library(readxl)
library(janitor)
library(stringdist)
library(fuzzyjoin)

knitr::opts_chunk$set(echo = TRUE)
```


```{r}
scores <- read_excel("PH_Inspections_data_dotgov_27JUN2023.xlsx") %>% 
  clean_names()
```

```{r}
nycha_scores <- scores %>% filter(pha_name == "New York City Housing Authority") %>% 
  mutate(raw_score = as.integer(str_replace_all(inspection_score, "[*abc]", "")),
         pass = if_else(raw_score >= 60, T, F),
         h_s_score = toupper(str_replace_all(inspection_score, "[*0-9]", "")),
         smoke_detectors = if_else(str_detect(inspection_score, "\\*"), "Yes", "No")
  )

write_csv(nycha_scores, "nycha_scores.csv")
```

```{r}

nycha_bees <- beeswarm(
  raw_score ~ axis,
  data = nycha_scores %>% mutate(axis = 0),
  method = "compactswarm",
  cex = 1,
  vertical = F,
  pch = 16,
)

rownames(nycha_bees) <- NULL


nycha_scores_beeswarm <- bind_cols(nycha_bees, nycha_scores) %>% 
  select(x = y, y = x, development_name, pass, raw_score) #this is dumb but makes is a lot easier for DW to read. Switching it to horizontal by just renaming and reordering the x and y columns

write_csv(nycha_scores_beeswarm, "scores_swarm_dw.csv")

```

```{r}

nycha_scores %>% 
  select(`Development Name` = development_name,
         `Borough` = development_city,
         `Units` = development_acc_unit_count,
         `Overall Score` = raw_score,
         `Health & Safety Scores` = h_s_score,
         `Smoke Detector Deficiencies` = smoke_detectors) %>% 
  write_csv("scores_table_dw.csv")


```

```{r}

nhpd_reac <-read_excel("active_ph_pbs8_nystate.xlsx") %>% 
  clean_names()
  
nyc_nhpd <- filter(nhpd_reac, county %in% c("Kings", "Richmond", "New York", "Bronx", "Queens"))

nycha_nhpd <- filter(nyc_nhpd, manager_name %in% c("New York City Housing Authority", "NEW YORK CITY HOUSING AUTHORITY")) %>% 
  mutate(property_name = case_when(
    property_name == "RED HOOK I EAST" ~ "red hook i (east)",
    property_name == "AMSTERDAM" & nhpd_property_id == "1072768" ~ "amsterdam addition",
    property_name == "BAYVIEW HOUSES" ~ "bay view",
    T ~ property_name
  ))

hud_nhpd_join <- left_join(
          nycha_scores %>% mutate(development_name = tolower(development_name)),
          nycha_nhpd %>% mutate(property_name = tolower(property_name)),
          by = c("development_name" = "property_name", "inspection_date" = "last_reac_date")
)

nomatch_hud <- anti_join(
          nycha_scores %>% mutate(development_name = tolower(development_name)),
          nycha_nhpd %>% mutate(property_name = tolower(property_name)),
          by = c("development_name" = "property_name")
)

nomatch_nhpd <- anti_join(
          nycha_nhpd %>% mutate(property_name = tolower(property_name)),
          nycha_scores %>% mutate(development_name = tolower(development_name)),
          by = c("property_name" = "development_name")
)

```


```{r}
stringdistmatrix(nycha_scores$development_name, nycha_nhpd$property_name, method = "jw")

fuzzy_join <- stringdist_join(nycha_scores, nycha_nhpd,
          by = c("development_name" = "property_name"),
          mode = "left",
          max_dist = 2,
          ignore_case = T,
          distance_col = "dist") %>% 
  select(development_name, property_name, dist)


```


